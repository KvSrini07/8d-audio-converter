<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8D Pro & 5.1 Audio Converter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load LameJS for MP3 Encoding -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #f97316;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .container-box {
            background-color: #1e293b;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background-color: var(--primary-color);
            transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .btn-option {
            border: 2px solid #334155;
            transition: all 0.2s ease;
        }
        .btn-option:hover {
            border-color: #475569;
            background-color: #334155;
        }
        .btn-option.selected {
            border-color: var(--secondary-color);
            background-color: rgba(249, 115, 22, 0.1);
            color: white;
        }
        .btn-option.selected .check-icon {
            opacity: 1;
        }
        .download-option {
            transition: all 0.15s ease-in-out;
        }
        .download-option:hover {
            background-color: #334155;
            border-color: var(--secondary-color);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="container-box max-w-2xl w-full p-8 rounded-2xl space-y-8">
        
        <div class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">8D Pro Converter</h1>
            <p class="text-sm text-slate-400">True 360Â° Binaural Audio & 5.1 Surround Upmixing</p>
        </div>

        <!-- Step 1: File Upload -->
        <div id="step-upload" class="space-y-4 border border-slate-700 p-6 rounded-xl bg-slate-800/50">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white flex items-center">
                    <span class="bg-blue-600 text-xs rounded px-2 py-1 mr-2">STEP 1</span> Upload Song
                </h2>
            </div>
            <div class="relative group">
                <input type="file" id="audio-file-input" accept="audio/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="border-2 border-dashed border-slate-600 rounded-lg p-8 text-center transition group-hover:border-blue-500 group-hover:bg-slate-700/30">
                    <div class="text-4xl mb-2">ðŸŽ§</div>
                    <p class="text-slate-300 font-medium">Click to upload or drag & drop</p>
                    <p class="text-xs text-slate-500 mt-1">Supports MP3, WAV, FLAC</p>
                    <p id="file-status" class="text-sm text-blue-400 mt-4 font-mono hidden"></p>
                </div>
            </div>
        </div>

        <!-- Step 2: Choose Format -->
        <div id="step-format" class="space-y-4 border border-slate-700 p-6 rounded-xl bg-slate-800/50 opacity-50 pointer-events-none transition-opacity duration-300">
            <h2 class="text-lg font-semibold text-white flex items-center">
                <span class="bg-blue-600 text-xs rounded px-2 py-1 mr-2">STEP 2</span> Select Physics Engine
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 8D Option -->
                <button onclick="selectMode('8d')" id="mode-8d" class="btn-option selected relative p-5 rounded-xl text-left">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg">True 8D Audio</h3>
                            <p class="text-xs text-slate-400 mt-1">360Â° Circular Panning (HRTF).</p>
                            <p class="text-[10px] text-slate-500 mt-1">Simulates sound rotating around your head with concert reverb.</p>
                        </div>
                        <span class="check-icon opacity-100 text-orange-500 text-xl">âœ“</span>
                    </div>
                </button>

                <!-- 5.1 Option -->
                <button onclick="selectMode('5.1')" id="mode-5.1" class="btn-option relative p-5 rounded-xl text-left">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg">Dolby Atmos 5.1</h3>
                            <p class="text-xs text-slate-400 mt-1">(Simulated Upmix)</p>
                            <p class="text-[10px] text-slate-500 mt-1">Splits channels to 6 separate speakers (FL, FR, C, LFE, SL, SR).</p>
                        </div>
                        <span class="check-icon opacity-0 text-orange-500 text-xl">âœ“</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Step 3: Convert -->
        <div id="step-convert" class="pt-2 opacity-50 pointer-events-none transition-opacity duration-300">
            <button id="convert-button" class="btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center space-x-2">
                <span id="convert-text">Convert Audio</span>
                <div id="loading-indicator" class="hidden w-6 h-6 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
            <div id="message-box" class="hidden mt-4 p-4 text-center rounded-lg text-sm bg-green-900/50 text-green-300 border border-green-700/50">
                Processing Complete!
            </div>
        </div>

        <!-- Step 4: Download -->
        <div id="step-download" class="space-y-4 border border-green-900/30 p-6 rounded-xl bg-slate-800/50 hidden animate-in fade-in slide-in-from-bottom-4">
            <h2 class="text-lg font-semibold text-white flex items-center">
                <span class="bg-green-600 text-xs rounded px-2 py-1 mr-2">STEP 3</span> Download Format
            </h2>

            <!-- WAV Download -->
            <button data-format="wav" class="download-option w-full p-4 rounded-lg border-2 border-slate-700 bg-slate-800 text-left group">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="font-bold text-white block group-hover:text-blue-400 transition-colors">Download WAV (Lossless)</span>
                        <span class="text-xs text-slate-400 block mt-1" id="wav-desc">Highest Quality. Preserves original Sample Rate.</span>
                    </div>
                    <svg class="w-6 h-6 text-slate-500 group-hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </div>
            </button>

            <div class="grid grid-cols-2 gap-4">
                <!-- MP3 Download -->
                <button data-format="mp3" id="btn-mp3" class="download-option p-3 rounded-lg border border-slate-700 bg-slate-800/50 text-left transition hover:bg-slate-700 hover:border-orange-500">
                    <span class="font-bold text-white text-sm block">MP3 (320kbps)</span>
                    <span class="text-[10px] text-slate-400">High Quality</span>
                </button>
                
                <!-- FLAC Download -->
                <button data-format="flac" id="btn-flac" class="download-option p-3 rounded-lg border border-slate-700 bg-slate-800/50 text-left transition hover:bg-slate-700 hover:border-orange-500">
                    <span class="font-bold text-white text-sm block">FLAC</span>
                    <span class="text-[10px] text-slate-400">Lossless Audio</span>
                </button>
            </div>
            
            <div id="download-message-box" class="hidden p-3 text-center rounded-lg text-xs bg-red-900/50 text-red-300 border border-red-700/50"></div>
        </div>

        <!-- Footer -->
        <div class="text-center pt-6 border-t border-slate-700/50">
            <p class="text-xs text-slate-500 font-medium tracking-wide">Created by : <span class="text-slate-400 font-semibold">Srinivasan K.V</span></p>
        </div>

    </div>

    <script>
        // --- State Management ---
        let audioContext;
        let originalBuffer = null;
        let processedBuffer = null;
        let inputFileName = 'audio';
        let currentMode = '8d'; // '8d' or '5.1'

        // --- DOM Elements ---
        const ui = {
            fileInput: document.getElementById('audio-file-input'),
            fileStatus: document.getElementById('file-status'),
            stepFormat: document.getElementById('step-format'),
            stepConvert: document.getElementById('step-convert'),
            convertBtn: document.getElementById('convert-button'),
            convertText: document.getElementById('convert-text'),
            loader: document.getElementById('loading-indicator'),
            msgBox: document.getElementById('message-box'),
            stepDownload: document.getElementById('step-download'),
            dlMsgBox: document.getElementById('download-message-box'),
            mode8d: document.getElementById('mode-8d'),
            mode51: document.getElementById('mode-5.1'),
            wavDesc: document.getElementById('wav-desc'),
            btnMp3: document.getElementById('btn-mp3')
        };

        // --- Mode Selection ---
        window.selectMode = (mode) => {
            currentMode = mode;
            
            // Visual Updates
            if (mode === '8d') {
                ui.mode8d.classList.add('selected');
                ui.mode51.classList.remove('selected');
                ui.mode8d.querySelector('.check-icon').style.opacity = '1';
                ui.mode51.querySelector('.check-icon').style.opacity = '0';
                ui.wavDesc.textContent = "Stereo WAV file with 360Â° binaural panning.";
            } else {
                ui.mode51.classList.add('selected');
                ui.mode8d.classList.remove('selected');
                ui.mode51.querySelector('.check-icon').style.opacity = '1';
                ui.mode8d.querySelector('.check-icon').style.opacity = '0';
                ui.wavDesc.textContent = "6-Channel WAV (5.1 Surround). Uncompressed.";
            }
        };

        const ensureContext = () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        };

        // --- Step 1: File Upload & Decode ---
        ui.fileInput.addEventListener('change', (e) => {
            ensureContext();
            const file = e.target.files[0];
            if (!file) return;

            ui.fileStatus.textContent = "Loading...";
            ui.fileStatus.classList.remove('hidden');
            ui.stepDownload.classList.add('hidden');
            ui.msgBox.classList.add('hidden');
            
            inputFileName = file.name.replace(/\.[^/.]+$/, "");
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                ui.fileStatus.textContent = "Decoding audio data...";
                audioContext.decodeAudioData(ev.target.result, (buffer) => {
                    originalBuffer = buffer;
                    ui.fileStatus.textContent = `Loaded: ${file.name} (${buffer.duration.toFixed(1)}s @ ${buffer.sampleRate}Hz)`;
                    ui.stepFormat.classList.remove('opacity-50', 'pointer-events-none');
                    ui.stepConvert.classList.remove('opacity-50', 'pointer-events-none');
                }, (err) => {
                    ui.fileStatus.textContent = "Error decoding file.";
                    console.error(err);
                });
            };
            reader.readAsArrayBuffer(file);
        });

        // --- Step 2: Processing Logic ---
        ui.convertBtn.addEventListener('click', async () => {
            if (!originalBuffer) return;

            ui.convertBtn.disabled = true;
            ui.convertText.textContent = `Processing ${currentMode === '8d' ? 'True 8D' : '5.1'}...`;
            ui.loader.classList.remove('hidden');
            ui.stepDownload.classList.add('hidden');
            ui.msgBox.classList.add('hidden');

            try {
                await new Promise(r => setTimeout(r, 100)); // Yield to UI
                
                if (currentMode === '8d') {
                    await process8D();
                } else {
                    await process51();
                }

                ui.convertText.textContent = 'Convert Audio';
                ui.loader.classList.add('hidden');
                ui.convertBtn.disabled = false;
                ui.msgBox.classList.remove('hidden');
                ui.stepDownload.classList.remove('hidden');
                ui.stepDownload.scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                console.error(e);
                ui.convertText.textContent = 'Error';
                ui.loader.classList.add('hidden');
                ui.convertBtn.disabled = false;
                alert("Processing failed: " + e.message);
            }
        });

        // --- 8D Processing Logic (True 360 HRTF) ---
        async function process8D() {
            // Use OfflineContext to render faster than real-time
            const offlineCtx = new OfflineAudioContext(2, originalBuffer.length, originalBuffer.sampleRate);
            
            // Source
            const source = offlineCtx.createBufferSource();
            source.buffer = originalBuffer;

            // HRTF Panner (3D Audio)
            const panner = offlineCtx.createPanner();
            panner.panningModel = 'HRTF'; // Key for 8D
            panner.distanceModel = 'inverse';
            panner.refDistance = 1;
            panner.maxDistance = 10000;
            panner.rolloffFactor = 1;
            panner.coneInnerAngle = 360;
            panner.coneOuterAngle = 0;
            panner.coneOuterGain = 0;

            // Reverb (Convolver) - Creates the "Space"
            const convolver = offlineCtx.createConvolver();
            // Create a simple impulse response for reverb
            const rate = offlineCtx.sampleRate;
            const length = rate * 2; // 2 seconds reverb
            const impulse = offlineCtx.createBuffer(2, length, rate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const decay = Math.pow(1 - i / length, 2); // Simple decay
                left[i] = (Math.random() * 2 - 1) * decay;
                right[i] = (Math.random() * 2 - 1) * decay;
            }
            convolver.buffer = impulse;

            // Reverb Gain (Mix)
            const reverbGain = offlineCtx.createGain();
            reverbGain.gain.value = 0.25; // 25% wet

            // Dry Gain
            const dryGain = offlineCtx.createGain();
            dryGain.gain.value = 0.8;

            // 360 Rotation Logic
            const duration = originalBuffer.duration;
            const circleDuration = 10; // Seconds per full circle
            const radius = 3; // Distance from head
            
            // Loop through time to set positions
            // Web Audio API automation for Panner
            const steps = Math.ceil(duration * 20); // 20 updates per second
            
            for (let i = 0; i < steps; i++) {
                const time = (i / steps) * duration;
                const angle = (time / circleDuration) * 2 * Math.PI;
                
                // Calculate X and Z for circular motion
                // Z is front/back, X is left/right
                const x = Math.sin(angle) * radius;
                const z = Math.cos(angle) * radius;
                const y = 0; // Eye level

                panner.positionX.setValueAtTime(x, time);
                panner.positionY.setValueAtTime(y, time);
                panner.positionZ.setValueAtTime(z, time);
                
                // Orientation - always face the listener? No, source orientation usually static or rotating.
                // Leave orientation default.
            }

            // Connections
            // Source -> Panner -> DryGain -> Destination
            // Source -> Panner -> Convolver -> ReverbGain -> Destination
            source.connect(panner);
            panner.connect(dryGain);
            panner.connect(convolver);
            convolver.connect(reverbGain);
            dryGain.connect(offlineCtx.destination);
            reverbGain.connect(offlineCtx.destination);

            source.start();

            processedBuffer = await offlineCtx.startRendering();
        }

        // --- 5.1 Surround Processing Logic ---
        async function process51() {
            const offlineCtx = new OfflineAudioContext(6, originalBuffer.length, originalBuffer.sampleRate);
            const source = offlineCtx.createBufferSource();
            source.buffer = originalBuffer;

            const splitter = offlineCtx.createChannelSplitter(2);
            source.connect(splitter);
            const merger = offlineCtx.createChannelMerger(6);

            // Channel Mapping:
            // 0: FL, 1: FR, 2: C, 3: LFE, 4: SL, 5: SR

            // Front Left
            splitter.connect(merger, 0, 0);
            // Front Right
            splitter.connect(merger, 1, 1);
            
            // Center (Mono Mix)
            const centerGain = offlineCtx.createGain();
            centerGain.gain.value = 0.5; 
            splitter.connect(centerGain, 0);
            splitter.connect(centerGain, 1);
            centerGain.connect(merger, 0, 2);
            
            // LFE (Low Pass)
            const lfeFilter = offlineCtx.createBiquadFilter();
            lfeFilter.type = "lowpass";
            lfeFilter.frequency.value = 120; 
            const lfeGain = offlineCtx.createGain();
            lfeGain.gain.value = 0.8;
            splitter.connect(lfeFilter, 0); 
            splitter.connect(lfeFilter, 1);
            lfeFilter.connect(lfeGain);
            lfeGain.connect(merger, 0, 3);
            
            // Surround Left (Delay)
            const slDelay = offlineCtx.createDelay();
            slDelay.delayTime.value = 0.02;
            const slGain = offlineCtx.createGain();
            slGain.gain.value = 0.7; 
            splitter.connect(slDelay, 0);
            slDelay.connect(slGain);
            slGain.connect(merger, 0, 4);
            
            // Surround Right (Delay)
            const srDelay = offlineCtx.createDelay();
            srDelay.delayTime.value = 0.02; 
            const srGain = offlineCtx.createGain();
            srGain.gain.value = 0.7;
            splitter.connect(srDelay, 1);
            srDelay.connect(srGain);
            srGain.connect(merger, 0, 5);

            merger.connect(offlineCtx.destination);
            source.start();

            processedBuffer = await offlineCtx.startRendering();
        }

        // --- Download Handlers ---
        document.querySelector('button[data-format="wav"]').addEventListener('click', () => downloadWAV());
        
        ui.btnMp3.addEventListener('click', () => {
            if (typeof lamejs === 'undefined') {
                ui.dlMsgBox.textContent = "MP3 Library failed to load. Check internet.";
                ui.dlMsgBox.classList.remove('hidden');
            } else {
                downloadMP3();
            }
        });

        // FLAC Button -> Downloads WAV (Lossless Alternative)
        document.querySelector('button[data-format="flac"]').addEventListener('click', () => {
             ui.dlMsgBox.textContent = "Downloading High-Resolution WAV (FLAC alternative)...";
             ui.dlMsgBox.classList.remove('hidden', 'bg-red-900/50', 'text-red-300', 'border-red-700/50');
             ui.dlMsgBox.classList.add('bg-blue-900/50', 'text-blue-300', 'border-blue-700/50');
             setTimeout(() => {
                 downloadWAV(); 
                 ui.dlMsgBox.classList.add('hidden');
             }, 500);
        });

        function downloadWAV() {
            if (!processedBuffer) return;
            const buffer = encodeWav(processedBuffer);
            const blob = new Blob([buffer], { type: 'audio/wav' });
            triggerDownload(blob, 'wav');
        }

        function downloadMP3() {
            if (!processedBuffer) return;
            ui.dlMsgBox.textContent = "Encoding High-Quality 320kbps MP3... This may take a few seconds.";
            ui.dlMsgBox.classList.remove('hidden');
            ui.dlMsgBox.classList.add('bg-blue-900/50', 'text-blue-300', 'border-blue-700/50');

            setTimeout(() => {
                try {
                    const mp3Blob = encodeMp3(processedBuffer);
                    triggerDownload(mp3Blob, 'mp3');
                    ui.dlMsgBox.classList.add('hidden');
                } catch (e) {
                    console.error(e);
                    ui.dlMsgBox.textContent = "MP3 Encoding Failed.";
                }
            }, 100);
        }

        function triggerDownload(blob, ext) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const suffix = currentMode === '8d' ? '_8D_Pro' : '_5.1_Surround';
            a.download = `${inputFileName}${suffix}.${ext}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- Encoders (WAV & MP3) ---
        function encodeMp3(audioBuffer) {
            const channels = Math.min(2, audioBuffer.numberOfChannels);
            const sampleRate = audioBuffer.sampleRate;
            const mp3Encoder = new lamejs.Mp3Encoder(channels, sampleRate, 320);
            const blockSize = 1152;
            const mp3Data = [];

            const left = audioBuffer.getChannelData(0);
            const right = channels > 1 ? audioBuffer.getChannelData(1) : left;
            
            for (let i = 0; i < left.length; i += blockSize) {
                const leftChunk = left.subarray(i, i + blockSize);
                const rightChunk = right.subarray(i, i + blockSize);
                const leftInt16 = new Int16Array(leftChunk.length);
                const rightInt16 = new Int16Array(rightChunk.length);
                
                for (let j = 0; j < leftChunk.length; j++) {
                    leftInt16[j] = Math.max(-1, Math.min(1, leftChunk[j])) * (leftChunk[j] < 0 ? 0x8000 : 0x7FFF);
                    rightInt16[j] = Math.max(-1, Math.min(1, rightChunk[j])) * (rightChunk[j] < 0 ? 0x8000 : 0x7FFF);
                }
                const mp3buf = mp3Encoder.encodeBuffer(leftInt16, rightInt16);
                if (mp3buf.length > 0) mp3Data.push(mp3buf);
            }
            const endBuf = mp3Encoder.flush();
            if (endBuf.length > 0) mp3Data.push(endBuf);
            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        function encodeWav(audioBuffer) {
            const numChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1; 
            const bitDepth = 16;
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            const length = audioBuffer.length * numChannels * bytesPerSample;
            const buffer = new ArrayBuffer(44 + length);
            const view = new DataView(buffer);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, length, true);

            let offset = 44;
            for (let i = 0; i < audioBuffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    let sample = audioBuffer.getChannelData(channel)[i];
                    sample = Math.max(-1, Math.min(1, sample)); 
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            return buffer;
        }
    </script>
</body>
</html>